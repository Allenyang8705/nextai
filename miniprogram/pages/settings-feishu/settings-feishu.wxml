<!--pages/settings-feishu/settings-feishu.wxml-->
<view class="feishu-settings-container">
  <!-- 头部 -->
  <view class="header">
    <view class="header-back" bindtap="goBack">
      <text>‹ 返回</text>
    </view>
    <text class="header-title">飞书文档同步设置</text>
  </view>

  <!-- 设置内容 -->
  <scroll-view class="content" scroll-y="{{true}}">
    <!-- 同步开关 -->
    <view class="section">
      <view class="section-title">同步开关</view>
      <view class="switch-item">
        <view class="switch-label">
          <text class="label-text">开启自动同步</text>
          <text class="label-desc">语音转写完成后自动同步到飞书文档</text>
        </view>
        <switch
          checked="{{isEnabled}}"
          bindchange="onEnabledChange"
          disabled="{{!isConfigured}}"
        />
      </view>
    </view>

    <!-- 飞书文档配置 -->
    <view class="section">
      <view class="section-title">飞书文档配置</view>

      <view class="input-group">
        <text class="input-label">文档链接</text>
        <input
          class="input-box"
          type="text"
          placeholder="请输入飞书文档链接"
          value="{{documentUrl}}"
          bindinput="onDocumentUrlInput"
        />
        <view class="input-hint">
          <text>如何获取？</text>
          <text class="link" bindtap="showDocumentHelp">查看帮助</text>
        </view>
      </view>

      <view class="input-group">
        <text class="input-label">App ID</text>
        <input
          class="input-box"
          type="text"
          placeholder="cli_xxxxxxxxx"
          value="{{appId}}"
          bindinput="onAppIdInput"
        />
        <view class="input-hint">
          <text>如何获取？</text>
          <text class="link" bindtap="showAppHelp">查看帮助</text>
        </view>
      </view>

      <view class="input-group">
        <text class="input-label">App Secret</text>
        <input
          class="input-box"
          type="text"
          placeholder="请输入 App Secret"
          value="{{appSecret}}"
          bindinput="onAppSecretInput"
        />
      </view>

      <button class="btn-primary btn-block" bindtap="testConnection" disabled="{{testing}}">
        {{testing ? '测试中...' : '测试连接'}}
      </button>

      <!-- 测试结果 -->
      <view wx:if="{{testResult}}" class="test-result {{testSuccess ? 'success' : 'error'}}">
        <text class="result-icon">{{testSuccess ? '✓' : '✗'}}</text>
        <text class="result-text">{{testResult}}</text>
      </view>

      <button class="btn-secondary btn-block" bindtap="saveConfig" disabled="{{saving || !testSuccess}}">
        {{saving ? '保存中...' : '保存设置'}}
      </button>
    </view>

    <!-- 同步状态 -->
    <view class="section" wx:if="{{isConfigured}}">
      <view class="section-title">同步状态</view>

      <view class="status-item">
        <text class="status-icon">{{isConnected ? '🟢' : '🔴'}}</text>
        <view class="status-info">
          <text class="status-text">{{isConnected ? '已连接' : '未连接'}}</text>
          <text class="status-desc">{{lastSyncAt || '尚未同步'}}</text>
        </view>
      </view>

      <view class="sync-options">
        <text class="options-title">同步内容选项</text>
        <checkbox-group bindchange="onSyncOptionsChange">
          <label class="checkbox-item">
            <checkbox value="time" checked="{{syncOptions.time}}" />
            <text>录音时间</text>
          </label>
          <label class="checkbox-item">
            <checkbox value="duration" checked="{{syncOptions.duration}}" />
            <text>语音时长</text>
          </label>
          <label class="checkbox-item">
            <checkbox value="text" checked="{{syncOptions.text}}" />
            <text>转写文字内容</text>
          </label>
          <label class="checkbox-item">
            <checkbox value="audio" checked="{{syncOptions.audio}}" />
            <text>语音文件链接</text>
          </label>
        </checkbox-group>
      </view>
    </view>

    <!-- 帮助说明 -->
    <view class="section">
      <view class="section-title">帮助说明</view>
      <view class="help-card">
        <text class="help-title">如何获取飞书文档链接？</text>
        <text class="help-content">1. 打开飞书云文档\n2. 创建或选择一个文档\n3. 点击右上角"分享"按钮\n4. 选择"复制链接"</text>
      </view>
      <view class="help-card">
        <text class="help-title">如何获取应用凭证？</text>
        <text class="help-content">1. 访问飞书开放平台\n2. 创建企业自建应用\n3. 获取 App ID 和 App Secret\n4. 添加文档编辑权限</text>
      </view>
    </view>
  </scroll-view>
</view>

<!-- 文档链接帮助弹窗 -->
<view wx:if="{{showDocumentHelpModal}}" class="modal-mask" bindtap="hideDocumentHelp">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-title">如何获取文档链接</view>
    <view class="modal-body">
      <text class="step-number">1</text>
      <text class="step-text">打开飞书云文档，创建一个新文档（或使用现有文档）</text>
      <image class="step-image" src="/images/feishu-step1.png" mode="aspectFit" />
      <text class="step-number">2</text>
      <text class="step-text">点击右上角"分享"按钮，选择"复制链接"</text>
      <image class="step-image" src="/images/feishu-step2.png" mode="aspectFit" />
      <text class="step-number">3</text>
      <text class="step-text">从链接中提取 document_id，例如：\ndocx/doxcnXXXXXXXXXXXX</text>
    </view>
    <view class="modal-footer">
      <button class="btn-primary" bindtap="hideDocumentHelp">知道了</button>
    </view>
  </view>
</view>

<!-- 应用凭证帮助弹窗 -->
<view wx:if="{{showAppHelpModal}}" class="modal-mask" bindtap="hideAppHelp">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-title">如何获取应用凭证</view>
    <view class="modal-body">
      <text class="step-number">1</text>
      <text class="step-text">访问飞书开放平台，进入"开发者后台"</text>
      <text class="step-number">2</text>
      <text class="step-text">点击"创建企业自建应用"，填写应用信息并创建</text>
      <text class="step-number">3</text>
      <text class="step-text">在应用详情页获取 App ID 和 App Secret</text>
      <text class="step-number">4</text>
      <text class="step-text">在"权限管理"中添加以下权限：</text>
      <text class="step-list">• docx:document - 查看、编辑云文档</text>
      <text class="step-number">5</text>
      <text class="step-text">创建可用版本并发布</text>
    </view>
    <view class="modal-footer">
      <button class="btn-primary" bindtap="hideAppHelp">知道了</button>
      <button class="btn-secondary" bindtap="openFeishuPlatform">前往飞书开放平台</button>
    </view>
  </view>
</view>
